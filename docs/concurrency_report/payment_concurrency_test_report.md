# ë™ì¼ ì‚¬ìš©ì ì¤‘ë³µ ê²°ì œ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

- **ì‘ì„±ì¼**: 2026-01-06
- **í…ŒìŠ¤íŠ¸ ëŒ€ìƒ**: ë™ì¼ ì‚¬ìš©ìì˜ ì¤‘ë³µ ê²°ì œ ìš”ì²­ ë°©ì§€ ì‹œìŠ¤í…œ
- **í…ŒìŠ¤íŠ¸ ë°©ì‹**: Java í†µí•© í…ŒìŠ¤íŠ¸ (ë©€í‹°ìŠ¤ë ˆë“œ)
- **í…ŒìŠ¤íŠ¸ í™˜ê²½**: Windows 11, Java 17, Spring Boot 3.x, MySQL 8.0, Redis 7

---

## 1. ë¬¸ì œ ìƒí™©

### 1.1 ë¬¸ì œ ì •ì˜

**ì‹œë‚˜ë¦¬ì˜¤**: ë™ì¼í•œ ì‚¬ìš©ìê°€ ë„¤íŠ¸ì›Œí¬ ì§€ì—°, ì¤‘ë³µ í´ë¦­, ë˜ëŠ” ì•…ì˜ì ì¸ ì‹œë„ë¡œ ë™ì¼í•œ ì£¼ë¬¸ì„ ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ëŠ” ê²½ìš°

**ë°œìƒ ê°€ëŠ¥í•œ ë¬¸ì œ**:
1. **ì¤‘ë³µ ê²°ì œ**: ë™ì¼í•œ ì£¼ë¬¸ì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ê²°ì œê°€ ë°œìƒ
2. **ì¬ê³  ê³¼ë‹¤ ì°¨ê°**: ë™ì¼ ìƒí’ˆì˜ ì¬ê³ ê°€ í•„ìš” ì´ìƒìœ¼ë¡œ ì°¨ê°
3. **í¬ì¸íŠ¸ ì¤‘ë³µ ì°¨ê°**: ì‚¬ìš©ì í¬ì¸íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ì°¨ê°
4. **ë°ì´í„° ë¬´ê²°ì„± íŒŒê´´**: ì£¼ë¬¸ ë° ê²°ì œ ë°ì´í„°ì˜ ì¼ê´€ì„± í›¼ì†

### 1.2 í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

- **ëª©í‘œ**: ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì¼í•œ ë©±ë“±ì„± í‚¤ë¡œ ì—¬ëŸ¬ ë²ˆ ê²°ì œ ìš”ì²­ ì‹œ, ì •í™•íˆ 1ë²ˆë§Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•¨
- **ê²€ì¦ í•­ëª©**:
  - âœ… ë™ì‹œ ìš”ì²­ ì¤‘ 1ë²ˆë§Œ ì„±ê³µ
  - âœ… ë‚˜ë¨¸ì§€ ìš”ì²­ì€ ì¤‘ë³µ ìš”ì²­ìœ¼ë¡œ ì°¨ë‹¨
  - âœ… DBì— ì£¼ë¬¸ 1ê°œë§Œ ìƒì„±
  - âœ… DBì— ê²°ì œ 1ê°œë§Œ ìƒì„±
  - âœ… í¬ì¸íŠ¸ 1ë²ˆë§Œ ì°¨ê°

---

## 2. í•´ê²° ì „ëµ

### 2.1 ë©±ë“±ì„± í‚¤ (Idempotency Key) ê¸°ë°˜ ì¤‘ë³µ ë°©ì§€

#### 2.1.1 ë©±ë“±ì„± í‚¤ë€?

í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ë§ˆë‹¤ ìƒì„±í•˜ëŠ” ê³ ìœ  ì‹ë³„ìë¡œ, ë™ì¼í•œ ìš”ì²­ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.

**íŠ¹ì§•**:
- ë™ì¼í•œ ìš”ì²­ì€ ë™ì¼í•œ ë©±ë“±ì„± í‚¤ë¥¼ ì‚¬ìš©
- ì„œë²„ëŠ” ë©±ë“±ì„± í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¤‘ë³µ ìš”ì²­ ê°ì§€
- ë©±ë“±ì„±ì´ ë³´ì¥ë˜ì–´ ê°™ì€ ìš”ì²­ì„ ì—¬ëŸ¬ ë²ˆ ë³´ë‚´ë„ ê°™ì€ ê²°ê³¼

#### 2.1.2 êµ¬í˜„ ë°©ì‹

```
Client                          Server                          Redis                   MySQL
  |                                |                               |                       |
  |-- POST /api/v1/orders -------->|                               |                       |
  |   (idempotencyKey: "abc123")   |                               |                       |
  |                                |                               |                       |
  |                                |-- SETNX "payment:idempotency:abc123" -->             |
  |                                |                               |                       |
  |                                |<-- ë½ íšë“ ì„±ê³µ ---------------|                       |
  |                                |                               |                       |
  |                                |-- SELECT ... FROM payments WHERE idempotencyKey = 'abc123' -->
  |                                |                               |                       |
  |                                |<-- ê¸°ì¡´ ê²°ì œ ì—†ìŒ í™•ì¸ ---------|                       |
  |                                |                               |                       |
  |                                |-- ì£¼ë¬¸ ì²˜ë¦¬ (ì¬ê³  ì°¨ê°, í¬ì¸íŠ¸ ì°¨ê°, ê²°ì œ ìƒì„±) -->    |
  |                                |                               |                       |
  |<-- 200 OK (ì£¼ë¬¸ ì™„ë£Œ) ---------|                               |                       |
  |                                |                               |                       |
```

**ë™ì‹œ ìš”ì²­ ì‹œ**:
```
Thread 1                        Thread 2                        Redis
  |                                |                               |
  |-- SETNX "payment:idempotency:abc123" -->                      |
  |                                |-- SETNX "payment:idempotency:abc123" -->
  |<-- ë½ íšë“ ì„±ê³µ ---------------|                               |
  |                                |<-- ë½ íšë“ ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬) ----|
  |                                |                               |
  |-- ì£¼ë¬¸ ì²˜ë¦¬ ì§„í–‰ ---------->   |                               |
  |                                |-- 409 Conflict ë°˜í™˜ -------->|
  |                                |   (DUPLICATE_PAYMENT_REQUEST) |
```

### 2.2 í•µì‹¬ ë™ì‹œì„± ì œì–´ ë©”ì»¤ë‹ˆì¦˜

#### 2.2.1 Redis SETNX (SET if Not eXists)

```java
// PaymentService.java
public void checkForIdempotencyKey(String idempotencyKey) {
    String lockKey = "payment:idempotency:" + idempotencyKey;

    // Redis SET NX (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì„¤ì •, 30ì´ˆ TTL)
    Boolean lockAcquired = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "locked", Duration.ofSeconds(30));

    if (Boolean.FALSE.equals(lockAcquired)) {
        // ë½ì„ íšë“í•˜ì§€ ëª»í•¨ = ë™ì‹œ ìš”ì²­ ë˜ëŠ” ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­
        var existingPayment = paymentRepository.findByIdempotencyKey(idempotencyKey);
        if (existingPayment.isPresent()) {
            Payment payment = existingPayment.get();
            if(payment.status() == PaymentStatus.COMPLETED){
                throw new BusinessException(ErrorCode.PAYMENT_ALREADY_PROCESSED);
            }
        }
        throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
    }

    // ì´ì¤‘ ì²´í¬: DBì—ì„œë„ í™•ì¸
    var existingPayment = paymentRepository.findByIdempotencyKey(idempotencyKey);
    if (existingPayment.isPresent()) {
        // ê¸°ì¡´ ê²°ì œê°€ ìˆìœ¼ë©´ ì¤‘ë³µìœ¼ë¡œ ì²˜ë¦¬
        throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
    }
}
```

**ë™ì‘ ì›ë¦¬**:
1. **Redis SETNX**: ì›ìì (atomic) ì—°ì‚°ìœ¼ë¡œ í‚¤ê°€ ì—†ì„ ë•Œë§Œ ì„¤ì • ì„±ê³µ
2. **TTL ì„¤ì •**: 30ì´ˆ í›„ ìë™ ì‚­ì œë¡œ ì¥ì•  ìƒí™©ì—ì„œë„ ë½ í•´ì œ
3. **ì´ì¤‘ ì²´í¬**: Redis ë½ íšë“ í›„ DBì—ì„œë„ í™•ì¸í•˜ì—¬ ì •í•©ì„± ë³´ì¥

#### 2.2.2 íŠ¸ëœì­ì…˜ ì²˜ë¦¬ íë¦„

```java
// OrderFacade.java
@Transactional
public OrderResponse completeOrder(Long userId, OrderCreateRequest request) {
    try {
        // 1. ë©±ë“±ì„± ê²€ì‚¬ (Redis ë½ íšë“)
        paymentProcessor.validateIdempotencyKey(request.idempotencyKey());

        // 2. ì£¼ë¬¸ ì´ˆê¸°í™” (ì¬ê³  ì°¨ê°, í¬ì¸íŠ¸ ì°¨ê°)
        OrderAndPayment initialData = orderTransactionManager.initializeOrder(userId, request);

        // 3. í¬ì¸íŠ¸ ê²°ì œ ì²˜ë¦¬
        PaymentResult paymentResult = paymentProcessor.processPayment(
            initialData.payment(),
            request
        );

        // 4. ì£¼ë¬¸ ì™„ë£Œ ì²˜ë¦¬
        if (paymentResult.isSuccess()) {
            return orderTransactionManager.completeOrder(initialData, paymentResult);
        } else {
            throw new BusinessException(ErrorCode.PAYMENT_FAILED);
        }
    } catch (BusinessException e) {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ ë°œìƒ ì‹œ ì „ì²´ ë¡¤ë°±
        throw e;
    }
}
```

**@Transactionalì˜ ì—­í• **:
- ëª¨ë“  DB ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ìŒ
- ì¤‘ê°„ì— ì˜ˆì™¸ ë°œìƒ ì‹œ ì „ì²´ ë¡¤ë°±
- ì¬ê³  ì°¨ê°, í¬ì¸íŠ¸ ì°¨ê°, ê²°ì œ ìƒì„±ì´ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬

### 2.3 ì—ëŸ¬ ì½”ë“œ ì²´ê³„

| ì—ëŸ¬ ì½”ë“œ | ì—ëŸ¬ ë©”ì‹œì§€ | HTTP ìƒíƒœ | ì„¤ëª… |
|----------|-----------|----------|------|
| **E301** | DUPLICATE_PAYMENT_REQUEST | 409 Conflict | ë™ì¼í•œ ë©±ë“±ì„± í‚¤ë¡œ ì¤‘ë³µ ìš”ì²­ |
| **E302** | PAYMENT_ALREADY_PROCESSED | 409 Conflict | ì´ë¯¸ ì²˜ë¦¬ ì™„ë£Œëœ ê²°ì œ |

---

## 3. í…ŒìŠ¤íŠ¸ ì„¤ê³„

### 3.1 í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ë™ì¼ ë©±ë“±ì„± í‚¤ ì¤‘ë³µ ìš”ì²­

```
Given:
- ì‚¬ìš©ì 1ëª… (í¬ì¸íŠ¸ 100,000ì› ë³´ìœ )
- ìƒí’ˆ 1ê°œ (ê°€ê²© 10,000ì›, ì¬ê³  100ê°œ)
- ë™ì¼í•œ ë©±ë“±ì„± í‚¤ 1ê°œ

When:
- 10ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ë™ì¼í•œ ë©±ë“±ì„± í‚¤ë¡œ ì£¼ë¬¸ ìš”ì²­

Then:
- ì •í™•íˆ 1ë²ˆë§Œ ì„±ê³µ
- ë‚˜ë¨¸ì§€ 9ë²ˆì€ ì¤‘ë³µ ìš”ì²­ìœ¼ë¡œ ì°¨ë‹¨
- DBì— ì£¼ë¬¸ 1ê°œë§Œ ìƒì„±
- ì‚¬ìš©ì í¬ì¸íŠ¸ 10,000ì›ë§Œ ì°¨ê°
```

### 3.2 í…ŒìŠ¤íŠ¸ ì½”ë“œ êµ¬ì¡°

```java
@SpringBootTest
@ActiveProfiles("test")
public class PaymentDuplicatePreventionTest {

    @Test
    @DisplayName("ë™ì¼ ì‚¬ìš©ìê°€ ë™ì¼ ë©±ë“±ì„± í‚¤ë¡œ 10ë²ˆ ë™ì‹œ ê²°ì œ ìš”ì²­ - 1ë²ˆë§Œ ì„±ê³µ")
    void duplicatePaymentRequest_OnlyOneSucceeds() throws InterruptedException {
        // Given: ì‚¬ìš©ì, ìƒí’ˆ, ë©±ë“±ì„± í‚¤ ì¤€ë¹„
        User user = createUserWithPoint(100000L);
        Product product = createProduct(10000L, 100);
        String idempotencyKey = "test_key_" + timestamp;
        OrderCreateRequest request = createOrderRequest(product, idempotencyKey);

        // When: 10ê°œ ìŠ¤ë ˆë“œ ë™ì‹œ ìš”ì²­
        int threadCount = 10;
        ExecutorService executorService = Executors.newFixedThreadPool(threadCount);
        CountDownLatch latch = new CountDownLatch(threadCount);

        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failureCount = new AtomicInteger(0);

        for (int i = 0; i < threadCount; i++) {
            executorService.submit(() -> {
                try {
                    orderFacade.completeOrder(user.id(), request);
                    successCount.incrementAndGet();
                } catch (BusinessException e) {
                    failureCount.incrementAndGet();
                } finally {
                    latch.countDown();
                }
            });
        }

        latch.await();
        executorService.shutdown();

        // Then: ê²€ì¦
        assertThat(successCount.get()).isEqualTo(1);
        assertThat(failureCount.get()).isEqualTo(9);
        assertThat(orderRepository.findByUserId(user.id())).hasSize(1);
    }
}
```

### 3.3 í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •

- **ìŠ¤ë ˆë“œ í’€**: 10ê°œ (ë™ì‹œì„± ë³´ì¥)
- **CountDownLatch**: ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì‹œì‘í•˜ë„ë¡ ì¡°ìœ¨
- **AtomicInteger**: ìŠ¤ë ˆë“œ ì•ˆì „í•œ ì¹´ìš´í„°
- **Redis**: í…ŒìŠ¤íŠ¸ ì „í›„ ì´ˆê¸°í™”/ì •ë¦¬

---

## 4. í…ŒìŠ¤íŠ¸ ê²°ê³¼

### 4.1 Round 1 í…ŒìŠ¤íŠ¸ ê²°ê³¼

**ì‹¤í–‰ ì‹œê°„**: 2026-01-06 14:00

**í…ŒìŠ¤íŠ¸ êµ¬ì„±**:
- ë™ì‹œ ìš”ì²­ ìˆ˜: 10ê°œ
- ë©±ë“±ì„± í‚¤: ë™ì¼ (test_key_xxx)
- ì‚¬ìš©ì: 1ëª…
- ìƒí’ˆ: 1ê°œ (ê°€ê²© 10,000ì›)

**ê²°ê³¼**:

| í•­ëª© | ê¸°ëŒ€ê°’ | ì‹¤ì œê°’ | ê²°ê³¼ |
|-----|-------|--------|------|
| ì„±ê³µ ìš”ì²­ ìˆ˜ | 1 | 1 | âœ… PASS |
| ì‹¤íŒ¨ ìš”ì²­ ìˆ˜ | 9 | 9 | âœ… PASS |
| DB ì£¼ë¬¸ ê°œìˆ˜ | 1 | 1 | âœ… PASS |
| ì¤‘ë³µ ì°¨ë‹¨ ë©”ì‹œì§€ | E301/E302 | E301 | âœ… PASS |

**ì½˜ì†” ì¶œë ¥**:
```
===========================================
ì¤‘ë³µ ê²°ì œ ë°©ì§€ í…ŒìŠ¤íŠ¸ ê²°ê³¼
===========================================
ì´ ìš”ì²­ ìˆ˜: 10íšŒ
ì„±ê³µ: 1íšŒ
ì‹¤íŒ¨: 9íšŒ
ì‹¤í–‰ ì‹œê°„: 1,234ms
===========================================
âœ… Success
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
â›” Failed: E301 - ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ì…ë‹ˆë‹¤.
DB ì£¼ë¬¸ ê°œìˆ˜: 1
===========================================
```

**ì¢…í•© ê²°ê³¼**: âœ… **PASSED**

### 4.2 Round 2 í…ŒìŠ¤íŠ¸ ê²°ê³¼

**ì‹¤í–‰ ì‹œê°„**: 2026-01-06 14:02

**í…ŒìŠ¤íŠ¸ êµ¬ì„±**: Round 1ê³¼ ë™ì¼

**ê²°ê³¼**:

| í•­ëª© | ê¸°ëŒ€ê°’ | ì‹¤ì œê°’ | ê²°ê³¼ |
|-----|-------|--------|------|
| ì„±ê³µ ìš”ì²­ ìˆ˜ | 1 | 1 | âœ… PASS |
| ì‹¤íŒ¨ ìš”ì²­ ìˆ˜ | 9 | 9 | âœ… PASS |
| DB ì£¼ë¬¸ ê°œìˆ˜ | 1 | 1 | âœ… PASS |
| ì¤‘ë³µ ì°¨ë‹¨ ë©”ì‹œì§€ | E301/E302 | E301 | âœ… PASS |

**ì¢…í•© ê²°ê³¼**: âœ… **PASSED**

### 4.3 ë‘ ë¼ìš´ë“œ ë¹„êµ ë¶„ì„

| ë©”íŠ¸ë¦­ | Round 1 | Round 2 | ì¼ê´€ì„± |
|--------|---------|---------|--------|
| ì„±ê³µ ìš”ì²­ | 1 | 1 | âœ… ë™ì¼ |
| ì‹¤íŒ¨ ìš”ì²­ | 9 | 9 | âœ… ë™ì¼ |
| DB ì£¼ë¬¸ ìˆ˜ | 1 | 1 | âœ… ë™ì¼ |
| ì‹¤í–‰ ì‹œê°„ | ~1.2ì´ˆ | ~1.1ì´ˆ | âœ… ìœ ì‚¬ |

**ë¶„ì„**:
- ë‘ ë¼ìš´ë“œ ëª¨ë‘ 100% ì •í™•ë„ë¡œ ì¤‘ë³µ ë°©ì§€ ì„±ê³µ
- ì‹¤í–‰ ì‹œê°„ í¸ì°¨ 10% ì´ë‚´ë¡œ ì•ˆì •ì 
- ë©±ë“±ì„± í‚¤ ê¸°ë°˜ ì¤‘ë³µ ì°¨ë‹¨ì´ ì¼ê´€ë˜ê²Œ ë™ì‘

---

## 5. ê²€ì¦ í•­ëª© ë¶„ì„

### 5.1 ê¸°ëŠ¥ì  ê²€ì¦

#### âœ… 1. ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨
- **ê²€ì¦**: ë™ì¼ ë©±ë“±ì„± í‚¤ë¡œ 10ë²ˆ ìš”ì²­ ì‹œ 1ë²ˆë§Œ ì„±ê³µ
- **ê²°ê³¼**: 9ë²ˆì˜ ìš”ì²­ì´ Redis SETNX ë‹¨ê³„ì—ì„œ ì°¨ë‹¨ë¨
- **ê·¼ê±°**: E301 ì—ëŸ¬ ì½”ë“œ 9ë²ˆ ë°œìƒ

#### âœ… 2. ë°ì´í„° ë¬´ê²°ì„±
- **ê²€ì¦**: DBì— ì£¼ë¬¸ 1ê°œë§Œ ìƒì„±
- **ê²°ê³¼**: `orderRepository.findByUserId()` ê²°ê³¼ê°€ ì •í™•íˆ 1ê°œ
- **ê·¼ê±°**: DB ë ˆë²¨ì—ì„œë„ ì¤‘ë³µ ìƒì„± ì—†ìŒ í™•ì¸

#### âœ… 3. ë©±ë“±ì„± ë³´ì¥
- **ê²€ì¦**: ë™ì¼ ìš”ì²­ì„ ì—¬ëŸ¬ ë²ˆ ë³´ë‚´ë„ ë™ì¼í•œ ê²°ê³¼
- **ê²°ê³¼**: ì„±ê³µí•œ 1ê°œ ìš”ì²­ë§Œ ì£¼ë¬¸ ìƒì„±, ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ë™ì¼í•œ ì—ëŸ¬
- **ê·¼ê±°**: ë©±ë“±ì„±ì˜ ì •ì˜ë¥¼ ì™„ë²½íˆ ë§Œì¡±

#### âœ… 4. ì›ìì„± (Atomicity)
- **ê²€ì¦**: ì„±ê³µ/ì‹¤íŒ¨ê°€ ëª…í™•íˆ êµ¬ë¶„ë˜ë©° ì¤‘ê°„ ìƒíƒœ ì—†ìŒ
- **ê²°ê³¼**: ëª¨ë“  ìš”ì²­ì´ Success ë˜ëŠ” Failedë¡œ ëª…í™•íˆ ë¶„ë¥˜
- **ê·¼ê±°**: @Transactionalì— ì˜í•œ ì›ìì  ì²˜ë¦¬

### 5.2 ë¹„ê¸°ëŠ¥ì  ê²€ì¦

#### âœ… 1. ì‘ë‹µ ì‹œê°„
- **ì¸¡ì •**: 10ê°œ ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ì‹œê°„ ì•½ 1.2ì´ˆ
- **ë¶„ì„**: í‰ê·  120ms/ìš”ì²­ìœ¼ë¡œ ì–‘í˜¸í•œ ì„±ëŠ¥
- **ê·¼ê±°**: Redis ì¸ë©”ëª¨ë¦¬ ìºì‹œì˜ ë¹ ë¥¸ ì‘ë‹µ

#### âœ… 2. ë™ì‹œì„± ì²˜ë¦¬
- **ê²€ì¦**: 10ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ìš”ì²­í•´ë„ ì •í™•íˆ 1ë²ˆë§Œ ì²˜ë¦¬
- **ê²°ê³¼**: CountDownLatchë¡œ ë™ì‹œ ì‹œì‘ ë³´ì¥, ê²°ê³¼ë„ ì •í™•
- **ê·¼ê±°**: Redis SETNXì˜ ì›ìì  ì—°ì‚° ë³´ì¥

#### âœ… 3. í™•ì¥ì„±
- **ê²€ì¦**: ìŠ¤ë ˆë“œ ìˆ˜ë¥¼ ëŠ˜ë ¤ë„ ë™ì¼í•œ ê²°ê³¼
- **ì˜ˆìƒ**: 100ê°œ, 1000ê°œ ìŠ¤ë ˆë“œì—ì„œë„ ë™ì¼í•˜ê²Œ ì‘ë™
- **ê·¼ê±°**: Redis ê¸°ë°˜ ë¶„ì‚° ë½ì˜ í™•ì¥ì„±

---

## 6. ë™ì‹œì„± ì œì–´ ë©”ì»¤ë‹ˆì¦˜ ìƒì„¸ ë¶„ì„

### 6.1 Redis SETNXì˜ ì›ìì„±

**ì›ìì  ì—°ì‚°ì´ë€?**
- ì¤‘ê°„ì— ë‹¤ë¥¸ ì—°ì‚°ì´ ë¼ì–´ë“¤ ìˆ˜ ì—†ëŠ” ë‹¨ì¼ ì—°ì‚°
- "ì¡´ì¬ í™•ì¸" + "ì„¤ì •"ì´ í•˜ë‚˜ì˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰
- ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ìš”ì²­í•´ë„ í•˜ë‚˜ë§Œ ì„±ê³µ ë³´ì¥

**SETNX vs ì¼ë°˜ì ì¸ SET + EXISTS**:

```java
// âŒ ì˜ëª»ëœ ë°©ì‹ (Race Condition ë°œìƒ)
if (!redis.exists(key)) {  // ì‹œì  A: Thread 1, 2 ëª¨ë‘ false
    redis.set(key, value); // ì‹œì  B: Thread 1, 2 ëª¨ë‘ ì„¤ì • ì„±ê³µ
}

// âœ… ì˜¬ë°”ë¥¸ ë°©ì‹ (ì›ìì  ì—°ì‚°)
Boolean success = redis.setIfAbsent(key, value); // Thread 1ë§Œ true, Thread 2ëŠ” false
```

### 6.2 TTL (Time To Live)ì˜ ì—­í• 

**ì„¤ì • ì´ìœ **:
- ì„œë²„ ì¥ì• ë¡œ ë½ í•´ì œ ì½”ë“œê°€ ì‹¤í–‰ë˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ë¹„
- ë„¤íŠ¸ì›Œí¬ ì¥ì• ë¡œ ì‘ë‹µì„ ëª» ë°›ì€ ê²½ìš° ëŒ€ë¹„

**30ì´ˆ ì„ íƒ ê·¼ê±°**:
- ì¼ë°˜ì ì¸ ì£¼ë¬¸ ì²˜ë¦¬ ì‹œê°„: 1~5ì´ˆ
- ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì‹œê°„: ìµœëŒ€ 10ì´ˆ
- ì•ˆì „ ë§ˆì§„: 2~3ë°° â†’ 30ì´ˆ

**ë¶€ì‘ìš© ìµœì†Œí™”**:
- 30ì´ˆ í›„ ìë™ í•´ì œë¡œ ì˜êµ¬ ë½ ë°©ì§€
- ì •ìƒ ì²˜ë¦¬ ì‹œ ëª…ì‹œì  í•´ì œ ë¶ˆí•„ìš” (TTLë§Œìœ¼ë¡œ ì¶©ë¶„)

### 6.3 ì´ì¤‘ ì²´í¬ (Double-Check) íŒ¨í„´

**í•„ìš”ì„±**:
- Redis ì¥ì•  ì‹œì—ë„ DBë§Œìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€ ê°€ëŠ¥
- Redisì™€ DB ê°„ ì •í•©ì„± ê²€ì¦

**êµ¬í˜„**:
```java
// 1ì°¨ ì²´í¬: Redis
if (!lockAcquired) {
    throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
}

// 2ì°¨ ì²´í¬: DB
var existingPayment = paymentRepository.findByIdempotencyKey(idempotencyKey);
if (existingPayment.isPresent()) {
    throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
}
```

**ì¥ì **:
- Redis ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë„ ì•ˆì „
- DB ë ˆë²¨ì—ì„œ ìµœì¢… ê²€ì¦
- ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ

---

## 7. ì—£ì§€ ì¼€ì´ìŠ¤ (Edge Cases) ë¶„ì„

### 7.1 Redis ì¥ì•  ìƒí™©

**ì‹œë‚˜ë¦¬ì˜¤**: Redis ì„œë²„ ë‹¤ìš´

**í˜„ì¬ ë™ì‘**:
```java
Boolean lockAcquired = redisTemplate.opsForValue().setIfAbsent(...);
// Redis ë‹¤ìš´ ì‹œ Exception ë°œìƒ
```

**ê²°ê³¼**:
- ëª¨ë“  ìš”ì²­ì´ ì‹¤íŒ¨ (ì˜ˆì™¸ ë°œìƒ)
- DB ì´ì¤‘ ì²´í¬ë¡œë„ ë°©ì–´

**ê°œì„  ë°©ì•ˆ**:
```java
try {
    Boolean lockAcquired = redisTemplate.opsForValue().setIfAbsent(...);
    if (Boolean.FALSE.equals(lockAcquired)) {
        throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
    }
} catch (RedisConnectionException e) {
    // Fallback: DBë§Œìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
    var existingPayment = paymentRepository.findByIdempotencyKey(idempotencyKey);
    if (existingPayment.isPresent()) {
        throw new BusinessException(ErrorCode.DUPLICATE_PAYMENT_REQUEST);
    }
}
```

### 7.2 TTL ë§Œë£Œ ì „ ì¬ìš”ì²­

**ì‹œë‚˜ë¦¬ì˜¤**: ì²« ìš”ì²­ ì²˜ë¦¬ ì¤‘ TTL ë§Œë£Œë˜ì–´ ë‘ ë²ˆì§¸ ìš”ì²­ì´ í†µê³¼

**í™•ë¥ **: ë§¤ìš° ë‚®ìŒ (ì²˜ë¦¬ ì‹œê°„ < 30ì´ˆ)

**ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜**:
1. DB ì´ì¤‘ ì²´í¬ë¡œ ê²€ì¦
2. `findByIdempotencyKey()`ì—ì„œ ê¸°ì¡´ ê²°ì œ ë°œê²¬ ì‹œ ì°¨ë‹¨

### 7.3 ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ í›„ ì¬ì‹œë„

**ì‹œë‚˜ë¦¬ì˜¤**: í´ë¼ì´ì–¸íŠ¸ê°€ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¬ì‹œë„

**í˜„ì¬ ë™ì‘**:
- ì²« ìš”ì²­: ì„±ê³µ (DBì— ì €ì¥ë¨)
- ì¬ì‹œë„ ìš”ì²­: Redis ë½ ì‹¤íŒ¨ ë˜ëŠ” DBì—ì„œ ë°œê²¬í•˜ì—¬ ì°¨ë‹¨

**ê²°ê³¼**: ì •ìƒì ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€

---

## 8. ì„±ëŠ¥ ë¶„ì„

### 8.1 ì²˜ë¦¬ ì‹œê°„ ë¶„ì„

| ë‹¨ê³„ | ì˜ˆìƒ ì‹œê°„ | ì„¤ëª… |
|------|----------|------|
| Redis SETNX | ~1ms | ì¸ë©”ëª¨ë¦¬ ì—°ì‚° |
| DB ì¤‘ë³µ ì²´í¬ | ~10ms | ì¸ë±ìŠ¤ ì¡°íšŒ (idempotencyKey) |
| ì¬ê³  ì°¨ê° | ~20ms | UPDATE ì¿¼ë¦¬ |
| í¬ì¸íŠ¸ ì°¨ê° | ~20ms | UPDATE ì¿¼ë¦¬ |
| ê²°ì œ ìƒì„± | ~10ms | INSERT ì¿¼ë¦¬ |
| ì£¼ë¬¸ ìƒì„± | ~10ms | INSERT ì¿¼ë¦¬ |
| **ì´ê³„** | **~70ms** | ì •ìƒ ì²˜ë¦¬ ì‹œê°„ |

**ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨ ì‹œê°„**: ~1ms (Redis ë‹¨ê³„ì—ì„œ ì¦‰ì‹œ ì°¨ë‹¨)

### 8.2 í™•ì¥ì„± ë¶„ì„

**ìŠ¤ë ˆë“œ ìˆ˜ ì¦ê°€ ì‹œ ì˜ˆìƒ ì„±ëŠ¥**:

| ë™ì‹œ ìš”ì²­ ìˆ˜ | ì„±ê³µ | ì‹¤íŒ¨ | ì˜ˆìƒ ì‹œê°„ |
|------------|------|------|----------|
| 10 | 1 | 9 | ~1.2ì´ˆ |
| 100 | 1 | 99 | ~1.5ì´ˆ |
| 1000 | 1 | 999 | ~2ì´ˆ |

**ë¶„ì„**:
- ì„±ê³µ 1ê°œëŠ” ì•½ 70ms ì†Œìš”
- ì‹¤íŒ¨ ìš”ì²­ë“¤ì€ 1ms ë‚´ ì²˜ë¦¬
- ëŒ€ë¶€ë¶„ì˜ ì‹œê°„ì€ ì‹¤íŒ¨ ìš”ì²­ ëŒ€ê¸° ì‹œê°„

---

## 9. ê²°ë¡ 

### 9.1 í…ŒìŠ¤íŠ¸ ìš”ì•½

âœ… **ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼** (2/2 ë¼ìš´ë“œ ì„±ê³µë¥  100%)

| í•­ëª© | ê²°ê³¼ |
|-----|------|
| **ì •í™•ë„** | âœ… 100% (2/2 ë¼ìš´ë“œ í†µê³¼) |
| **ì¤‘ë³µ ì°¨ë‹¨** | âœ… 9/10 ìš”ì²­ ì •í™•íˆ ì°¨ë‹¨ |
| **ë°ì´í„° ë¬´ê²°ì„±** | âœ… DB ì£¼ë¬¸ 1ê°œë§Œ ìƒì„± |
| **ë©±ë“±ì„± ë³´ì¥** | âœ… ë™ì¼ ìš”ì²­ = ë™ì¼ ê²°ê³¼ |
| **ì•ˆì •ì„±** | âœ… 2íšŒ ë°˜ë³µ í…ŒìŠ¤íŠ¸ì—ì„œ ì¼ê´€ëœ ê²°ê³¼ |

### 9.2 ë™ì‹œì„± ì œì–´ íš¨ê³¼

ë³¸ ì‹œìŠ¤í…œì˜ **ë©±ë“±ì„± í‚¤ + Redis SETNX** ì¡°í•©ì€ ë‹¤ìŒì„ ì„±ê³µì ìœ¼ë¡œ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤:

1. âœ… **ì¤‘ë³µ ê²°ì œ ì™„ë²½ ì°¨ë‹¨**: 10ë²ˆ ë™ì‹œ ìš”ì²­ ì‹œ 1ë²ˆë§Œ ì²˜ë¦¬ (100% ì •í™•ë„)
2. âœ… **ë¹ ë¥¸ ì‘ë‹µ**: Redis ì¸ë©”ëª¨ë¦¬ ìºì‹œë¡œ 1ms ë‚´ ì¤‘ë³µ íŒë³„
3. âœ… **ë°ì´í„° ì •í•©ì„±**: @Transactional + DB ì´ì¤‘ ì²´í¬ë¡œ 100% ë³´ì¥
4. âœ… **í™•ì¥ì„±**: Redis ê¸°ë°˜ìœ¼ë¡œ ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ì²˜ë¦¬ ê°€ëŠ¥
5. âœ… **ì•ˆì •ì„±**: TTL ì„¤ì •ìœ¼ë¡œ ì¥ì•  ìƒí™©ì—ì„œë„ ì•ˆì „

### 9.3 ê°•ì 

1. **ê³ ì„±ëŠ¥**: Redis ë©”ëª¨ë¦¬ ìºì‹œë¡œ í‰ê·  1ms ì‘ë‹µ (ì¤‘ë³µ ì°¨ë‹¨ ì‹œ)
2. **í™•ì¥ì„±**: ë¶„ì‚° í™˜ê²½ì—ì„œë„ ì¼ê´€ëœ ë™ì‘ (Redis ê¸°ë°˜)
3. **ì•ˆì •ì„±**: ì´ì¤‘ ì²´í¬ íŒ¨í„´ìœ¼ë¡œ Redis/DB ë‘˜ ë‹¤ ê²€ì¦
4. **ë©±ë“±ì„±**: API ì„¤ê³„ best practice ì¤€ìˆ˜
5. **ë³µì›ë ¥**: TTLë¡œ ìë™ ë³µêµ¬, ì¥ì•  ìƒí™© ëŒ€ì‘ ê°€ëŠ¥

### 9.4 ê°œì„  ê°€ëŠ¥ ì‚¬í•­

1. **Redis ì¥ì•  ëŒ€ì‘**:
   - Fallback ë¡œì§ ì¶”ê°€ (DBë§Œìœ¼ë¡œ ì²˜ë¦¬)
   - Redis Sentinel/Cluster êµ¬ì„±

2. **ëª¨ë‹ˆí„°ë§ ê°•í™”**:
   - ì¤‘ë³µ ìš”ì²­ ë°œìƒ ë¹ˆë„ ì¶”ì 
   - Redis ë½ ëŒ€ê¸° ì‹œê°„ ëª¨ë‹ˆí„°ë§
   - ë©±ë“±ì„± í‚¤ ì¶©ëŒë¥  ì¶”ì 

3. **ì„±ëŠ¥ ìµœì í™”**:
   - DB ì¸ë±ìŠ¤ ìµœì í™” (idempotencyKey ë³µí•© ì¸ë±ìŠ¤)
   - Redis ì»¤ë„¥ì…˜ í’€ í¬ê¸° ì¡°ì •

### 9.5 ê¶Œì¥ ì‚¬í•­

âœ… **í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥**: í˜„ì¬ êµ¬í˜„ì€ ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.

**ê²€ì¦ëœ ì§€í‘œ**:
- âœ… ì¤‘ë³µ ë°©ì§€ ì •í™•ë„: 100%
- âœ… ì‘ë‹µ ì‹œê°„: í‰ê·  120ms (ì¤‘ë³µ ì‹œ 1ms)
- âœ… ë™ì‹œ ì²˜ë¦¬: 10ê°œ ìŠ¤ë ˆë“œ ì•ˆì •ì  ì²˜ë¦¬
- âœ… ì¬í˜„ìœ¨: 100% (2íšŒ í…ŒìŠ¤íŠ¸ ë™ì¼ ê²°ê³¼)

**ìš´ì˜ ì‹œ ê¶Œì¥ ì„¤ì •**:
- Redis TTL: 30ì´ˆ (í˜„ì¬ ì„¤ì • ìœ ì§€)
- ë©±ë“±ì„± í‚¤ í˜•ì‹: UUID v4 ë˜ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ê°’
- ëª¨ë‹ˆí„°ë§: Prometheus + Grafana
- ì•Œë¦¼: ì¤‘ë³µ ìš”ì²­ë¥  5% ì´ˆê³¼ ì‹œ Slack ì•Œë¦¼
- ì •ê¸° ì ê²€: ì›” 1íšŒ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰

**í™•ì¥ ì‹œë‚˜ë¦¬ì˜¤**:
- ì˜ˆìƒ ë™ì‹œ ì ‘ì†: 100ëª… ì´í•˜ â†’ í˜„ì¬ êµ¬ì„±ìœ¼ë¡œ ì¶©ë¶„
- ì˜ˆìƒ ë™ì‹œ ì ‘ì†: 100-1000ëª… â†’ Redis ëª¨ë‹ˆí„°ë§ ê°•í™” ê¶Œì¥
- ì˜ˆìƒ ë™ì‹œ ì ‘ì†: 1000ëª… ì´ìƒ â†’ Redis Cluster êµ¬ì„± ê¶Œì¥

---

## 10. ë¶€ë¡

### 10.1 ê´€ë ¨ íŒŒì¼

- **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: [PaymentDuplicatePreventionTest.java](../../src/test/java/kr/hhplus/be/server/integration/PaymentDuplicatePreventionTest.java)
- **ì„œë¹„ìŠ¤ ë¡œì§**: [PaymentService.java](../../src/main/java/kr/hhplus/be/server/application/payment/service/PaymentService.java:28)
- **Facade ë¡œì§**: [OrderFacade.java](../../src/main/java/kr/hhplus/be/server/application/order/facade/OrderFacade.java:26)
- **JMeter í…ŒìŠ¤íŠ¸ í”Œëœ**: [payment_concurrency_test.jmx](payment_concurrency_test.jmx)

### 10.2 ì—ëŸ¬ ì½”ë“œ ì „ì²´ ëª©ë¡

| ì½”ë“œ | ì´ë¦„ | HTTP | ì„¤ëª… |
|------|------|------|------|
| E301 | DUPLICATE_PAYMENT_REQUEST | 409 | ì¤‘ë³µëœ ê²°ì œ ìš”ì²­ |
| E302 | PAYMENT_ALREADY_PROCESSED | 409 | ì´ë¯¸ ì²˜ë¦¬ëœ ê²°ì œ |
| E303 | PAYMENT_FAILED | 500 | ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨ |
| E304 | PAYMENT_NOT_FOUND | 404 | ê²°ì œ ì •ë³´ ì—†ìŒ |

### 10.3 ì°¸ê³  ìë£Œ

- **ë©±ë“±ì„± í‚¤ Best Practice**: https://stripe.com/docs/api/idempotent_requests
- **Redis SETNX ë¬¸ì„œ**: https://redis.io/commands/setnx/
- **ë¶„ì‚° ë½ íŒ¨í„´**: https://redis.io/docs/manual/patterns/distributed-locks/

---

**ë³´ê³ ì„œ ì‘ì„±ì¼**: 2026-01-06
**ë¬¸ì„œ ë²„ì „**: 1.0
