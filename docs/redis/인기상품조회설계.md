# 인기상품 조회 설계

## 1. 개요

인기상품 조회 기능은 최근 3일간 판매량 기준 상위 5개 상품을 실시간으로 제공하는 기능입니다.
Redis Sorted Set을 활용한 실시간 랭킹 시스템과 다단계 캐시 전략을 통해 고성능 및 고가용성을 보장합니다.

### 1.1 핵심 목표
- **실시간성**: 주문 완료 시 즉시 랭킹 반영
- **고성능**: Redis 기반 O(log N) 시간 복잡도로 빠른 조회
- **고가용성**: 다단계 Fallback으로 Redis 장애 시에도 서비스 지속
- **정합성**: 주문 취소 시 랭킹 점수 복원 (날짜 정합성 보장)

---

## 2. 핵심 요구사항

| 항목 | 요구사항 |
|------|----------|
| 조회 기간 | 최근 3일 (D-2 ~ D-0) |
| 조회 개수 | 상위 5개 상품 |
| 갱신 주기 | 실시간 (주문 완료/취소 시 즉시 반영) |
| 응답 시간 | 50ms 이하 (Redis 조회 기준) |
| 가용성 | Redis 장애 시 DB Fallback |

---

## 3. Redis Sorted Set 설계

### 3.1 키 구조

| 키 이름 | 용도 | TTL |
|--------|------|-----|
| `ranking:products:daily:{yyyyMMdd}` | 일별 판매량 저장 | 7일 |
| `ranking:products:aggregated` | ZUNIONSTORE 합산 결과 | 60초 |
| `ranking:products:cache` | 랭킹 조회 캐시 | 60초 |

### 3.2 데이터 구조

```
# 일별 판매량 (Sorted Set)
ranking:products:daily:20260206
  - member: "1" (상품 ID)
  - score: 150 (판매량)

ranking:products:daily:20260205
  - member: "1"
  - score: 120

# 합산 결과 (Sorted Set)
ranking:products:aggregated
  - member: "1"
  - score: 270 (3일 합산)
```

### 3.3 주요 Redis 명령어

| 동작 | 명령어 | 시간복잡도 |
|------|--------|-----------|
| 판매량 증가 | `ZINCRBY ranking:products:daily:{date} {quantity} {productId}` | O(log N) |
| 판매량 감소 | `ZSCORE` → `ZADD` or `ZREM` | O(log N) |
| 기간 합산 | `ZUNIONSTORE aggregated 3 daily:D-0 daily:D-1 daily:D-2` | O(N*K + M*log M) |
| 상위 조회 | `ZREVRANGE aggregated 0 4 WITHSCORES` | O(log N + M) |
| 캐시 무효화 | `DEL cache aggregated` | O(1) |

---

## 4. 다단계 캐시 전략

### 4.1 캐시 계층 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      인기상품 조회 요청                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  L0: Redis Sorted Set 실시간 랭킹                                │
│  - ProductRankingService.getTopRankingProducts()                │
│  - ZUNIONSTORE로 3일 합산 → ZREVRANGE로 상위 5개                  │
│  - TTL: 60초 (성능 최적화)                                       │
└─────────────────────────────────────────────────────────────────┘
                              │ (빈 결과일 경우)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  L1: Redis Cache (Cache-Aside)                                  │
│  - Key: cache:popular-products                                  │
│  - Value: List<PopularProductResponse> (JSON)                   │
│  - TTL: 25시간                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │ (캐시 미스)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  L2: DB 캐시 테이블 (popular_products)                           │
│  - 스케줄러가 매일 새벽 1시 갱신                                  │
│  - 조회 성공 시 L1에 Write-Back                                  │
└─────────────────────────────────────────────────────────────────┘
                              │ (데이터 없음)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  L3: 실시간 집계 (Fallback)                                      │
│  - ProductRepository.findPopularProducts()                      │
│  - DB 직접 집계 쿼리                                             │
│  - 조회 성공 시 L1에 Write-Back                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 캐시 TTL 설계

| 계층 | TTL | 이유 |
|------|-----|------|
| L0 (Sorted Set 캐시) | 60초 | 실시간성과 성능의 균형. ZUNIONSTORE 오버헤드 최소화 |
| L0 (일별 키) | 7일 | 3일 집계 기간 + 여유 기간 |
| L1 (Redis Cache) | 25시간 | 스케줄러 주기(24시간) + 버퍼(1시간) |
| L2 (DB 캐시) | 7일 | 히스토리 보관 및 롤백 대비 |

### 4.3 캐시 무효화 전략

```java
// 판매량 변경 시 캐시 무효화
private void invalidateCache() {
    redisTemplate.delete(CACHE_KEY);      // ranking:products:cache
    redisTemplate.delete(AGGREGATED_KEY); // ranking:products:aggregated
}
```

- **판매량 증가 시**: `incrementSalesScore()` 호출 후 캐시 무효화
- **판매량 감소 시**: `decrementSalesScore()` 호출 후 캐시 무효화
- **다음 조회 시**: 캐시 미스 → ZUNIONSTORE로 재계산

---

## 5. 판매량 반영 플로우

### 5.1 주문 완료 시 (판매량 증가)

```
┌──────────────┐     ┌─────────────────────┐     ┌──────────────────────┐
│ OrderFacade  │ ──▶ │ OrderTransaction    │ ──▶ │ ProductRanking       │
│ .createOrder │     │ Manager             │     │ Service              │
└──────────────┘     │ .completeOrder()    │     │ .incrementSalesScore │
                     └─────────────────────┘     └──────────────────────┘
                                                           │
                                                           ▼
                                                 ┌──────────────────────┐
                                                 │ Redis ZINCRBY        │
                                                 │ daily:{today}        │
                                                 │ + 캐시 무효화          │
                                                 └──────────────────────┘
```

### 5.2 주문 취소 시 (판매량 감소)

```
┌──────────────────┐     ┌──────────────────────┐
│ OrderCancellation│ ──▶ │ ProductRanking       │
│ Service          │     │ Service              │
│ .cancelOrder()   │     │ .decrementSalesScore │
└──────────────────┘     │ (productId, qty,     │
                         │  orderDate)          │ ◀── 주문 생성일 기준!
                         └──────────────────────┘
                                   │
                                   ▼
                         ┌──────────────────────┐
                         │ Redis                │
                         │ ZSCORE → 점수 감소    │
                         │ daily:{orderDate}    │ ◀── 주문일자 키에서 감소
                         │ + 캐시 무효화          │
                         └──────────────────────┘
```

**주문 취소 시 날짜 정합성**:
- 주문이 2월 4일에 생성되고 2월 6일에 취소될 경우
- `ranking:products:daily:20260204` 키에서 점수를 감소
- 현재 날짜(20260206)가 아닌 주문 생성일 기준으로 처리

---

## 6. 스케줄러 설계

### 6.1 배치 작업 구성

| 작업명 | 실행 시간 | 설명 |
|--------|----------|------|
| aggregatePopularProducts | 매일 01:00 | DB 기반 인기상품 집계 및 캐시 갱신 |
| cleanupOldData | 매일 04:00 | 7일 이전 데이터 정리 |

### 6.2 집계 배치 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                   매일 새벽 1시 실행                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 기존 데이터 삭제 (멱등성 보장)                                 │
│     popularProductRepository.deleteByBaseDate(today)            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. DB 집계 쿼리 실행                                            │
│     - 기간: D-3 ~ D-1 (직전 3일)                                 │
│     - 상위: 5개 상품                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. popular_products 테이블 저장                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Redis 캐시 갱신 (Cache Warming)                              │
│     - evictRedisCache() → 기존 캐시 삭제                         │
│     - putToRedisCache(responses) → 새 데이터 저장                │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 설정 값

```yaml
popular-product:
  top-count: 5
  period-days: 3
  cleanup-days: 7
  end-date-offset: 1
  schedule:
    aggregate-cron: "0 0 1 * * *"
    cleanup-cron: "0 0 4 * * *"
```

---

## 7. 응답 데이터 구조

```json
[
  {
    "id": 1,
    "productName": "노트북",
    "price": 1500000,
    "stock": 50,
    "category": "전자제품",
    "status": "ON_SALE",
    "salesQuantity": 270
  },
  {
    "id": 3,
    "productName": "무선 이어폰",
    "price": 250000,
    "stock": 100,
    "category": "전자제품",
    "status": "ON_SALE",
    "salesQuantity": 185
  }
]
```

---

## 8. 고려사항

### 8.1 성능 최적화

| 문제 | 해결책 |
|------|--------|
| ZUNIONSTORE 오버헤드 | 60초 TTL 캐시로 반복 연산 방지 |
| 매 요청마다 DB 조회 | 다단계 캐시 (L0 → L1 → L2 → L3) |
| Redis 네트워크 지연 | 로컬 캐시 고려 (향후 개선) |

### 8.2 데이터 정합성

| 문제 | 해결책 |
|------|--------|
| 주문 취소 시 날짜 불일치 | 주문 생성일 기준 점수 감소 |
| Redis-DB 불일치 | 캐시 무효화 + 스케줄러 동기화 |
| 동시성 이슈 | ZINCRBY 원자적 연산 사용 |

### 8.3 장애 대응

| 장애 유형 | 대응 방안 |
|----------|----------|
| Redis 연결 실패 | L1 → L2 → L3 Fallback |
| 스케줄러 실패 | 멱등성 보장, 수동 재실행 가능 |
| Redis 데이터 유실 | DB 캐시 테이블에서 복구 |

### 8.4 모니터링 지표

- Redis Sorted Set 키 개수 및 메모리 사용량
- 캐시 Hit Rate (L0, L1, L2)
- 랭킹 조회 응답 시간
- 스케줄러 실행 성공/실패 로그

---

## 9. 핵심 클래스 구조

```
application/product/service/
├── ProductService.java              # 인기상품 조회 (다단계 캐시)
└── ProductRankingService.java       # Redis Sorted Set 랭킹 관리

application/order/service/
├── OrderCancellationService.java    # 주문 취소 → 랭킹 감소

application/order/facade/
└── OrderTransactionManager.java     # 주문 완료 → 랭킹 증가

infrastructure/product/
└── PopularProductScheduler.java     # 배치 집계 스케줄러

domain/product/repository/
└── PopularProductRepository.java    # DB 캐시 테이블 접근
```

---

## 10. 시퀀스 다이어그램

### 10.1 인기상품 조회

```
Client          ProductController    ProductService    ProductRankingService    Redis
  │                    │                  │                    │                  │
  │──GET /popular──▶   │                  │                    │                  │
  │                    │──findPopular()─▶ │                    │                  │
  │                    │                  │──getTopRanking()──▶│                  │
  │                    │                  │                    │──ZREVRANGE cache─▶│
  │                    │                  │                    │◀──(캐시 Hit)──────│
  │                    │                  │◀─List<Response>────│                  │
  │                    │◀─────────────────│                    │                  │
  │◀──200 OK───────────│                  │                    │                  │
```

### 10.2 캐시 미스 시 ZUNIONSTORE

```
ProductRankingService                                   Redis
       │                                                  │
       │──ZREVRANGE cache──────────────────────────────▶  │
       │◀──(empty)─────────────────────────────────────── │
       │                                                  │
       │──ZUNIONSTORE aggregated 3 daily:D0 D1 D2──────▶  │
       │──EXPIRE aggregated 60────────────────────────▶   │
       │                                                  │
       │──ZREVRANGE aggregated 0 4 WITHSCORES──────────▶  │
       │◀──[(productId, score), ...]───────────────────── │
       │                                                  │
       │──ZADD cache (productId, score)──────────────▶    │
       │──EXPIRE cache 60────────────────────────────▶    │
       │                                                  │
```
