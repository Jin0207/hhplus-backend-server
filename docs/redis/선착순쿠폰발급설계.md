# 선착순 쿠폰 발급 설계

## 1. 개요

선착순 쿠폰 발급 기능은 한정 수량의 쿠폰을 요청 순서대로 발급하는 기능입니다.
Redis의 Set과 Sorted Set을 활용하여 중복 발급 방지와 선착순 순서 보장을 구현합니다.

### 1.1 핵심 목표
- **중복 방지**: 사용자당 1회만 발급 가능
- **순서 보장**: 요청 순서대로 선착순 발급
- **원자성**: Redis 원자적 연산으로 Race Condition 방지
- **정합성**: Redis-DB 간 데이터 일관성 유지

---

## 2. 핵심 요구사항

| 항목 | 요구사항 |
|------|----------|
| 발급 제한 | 사용자당 쿠폰별 1회 |
| 수량 제한 | 쿠폰별 최대 발급 수량 설정 |
| 순서 보장 | 요청 시간 기준 선착순 |
| 동시성 | 대량 동시 요청 처리 가능 |
| 원복 | 발급 실패 시 Redis 상태 롤백 |

---

## 3. Redis 자료구조 설계

### 3.1 키 구조

| 키 이름 | 자료구조 | 용도 |
|--------|----------|------|
| `coupon:issued:{couponId}` | Set | 중복 발급 방지 (발급된 userId 저장) |
| `coupon:request:{couponId}` | Sorted Set | 선착순 대기열 (요청 순서 기록) |
| `coupon:quantity:{couponId}` | String | 최대 발급 수량 (읽기 전용) |

### 3.2 데이터 구조

```
# 중복 발급 방지용 Set
coupon:issued:1
  - members: ["101", "102", "103"]  # 발급받은 userId

# 선착순 대기열 Sorted Set
coupon:request:1
  - member: "101", score: 1707200000001  # timestamp
  - member: "102", score: 1707200000005
  - member: "103", score: 1707200000010

# 최대 수량 String
coupon:quantity:1
  - value: "100"
```

### 3.3 주요 Redis 명령어

| 동작 | 명령어 | 시간복잡도 | 설명 |
|------|--------|-----------|------|
| 중복 체크 | `SADD coupon:issued:{id} {userId}` | O(1) | 0 반환 시 중복 |
| 대기열 등록 | `ZADD coupon:request:{id} {timestamp} {userId}` | O(log N) | 요청 순서 기록 |
| 순위 조회 | `ZRANK coupon:request:{id} {userId}` | O(log N) | 0-based 순위 |
| 수량 조회 | `GET coupon:quantity:{id}` | O(1) | 최대 발급 수량 |
| 롤백 (Set) | `SREM coupon:issued:{id} {userId}` | O(1) | 중복 체크 롤백 |
| 롤백 (ZSet) | `ZREM coupon:request:{id} {userId}` | O(log N) | 대기열 롤백 |

---

## 4. 발급 프로세스 설계

### 4.1 전체 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                      쿠폰 발급 요청                               │
│                   POST /coupons/{id}/issue                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1. 중복 발급 체크 (Redis Set)                              │
│  SADD coupon:issued:{couponId} {userId}                         │
│  - 반환값 1: 신규 발급 → 진행                                     │
│  - 반환값 0: 중복 발급 → 예외(COUPON_ALREADY_ISSUED)              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2. 선착순 대기열 등록 (Redis Sorted Set)                    │
│  ZADD coupon:request:{couponId} {timestamp} {userId}            │
│  - score: 현재 시각(ms) → 요청 순서 기록                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3. 선착순 검증 (순위 vs 수량)                               │
│  rank = ZRANK coupon:request:{couponId} {userId}                │
│  maxQty = GET coupon:quantity:{couponId}                        │
│  - rank < maxQty: 선착순 통과 → 진행                              │
│  - rank >= maxQty: 수량 초과 → 예외(COUPON_OUT_OF_STOCK)          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4. 쿠폰 조회 (비관적 락)                                    │
│  SELECT ... FROM coupon WHERE id = ? FOR UPDATE                 │
│  - 유효기간 및 상태 체크                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 5. DB 처리                                                 │
│  - UserCoupon 생성 및 저장                                       │
│  - Coupon 수량 차감                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      발급 완료                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 실패 시 롤백 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                  발급 중 예외 발생                                │
│  (DB 오류, 유효성 검증 실패, 수량 초과 등)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Redis 롤백                                                      │
│  - SREM coupon:issued:{couponId} {userId}                       │
│  - ZREM coupon:request:{couponId} {userId}                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  예외 전파 (BusinessException)                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 동시성 제어 전략

### 5.1 이중 락 전략

| 단계 | 락 유형 | 대상 | 목적 |
|------|--------|------|------|
| 1 | Redis SADD | coupon:issued | 중복 발급 방지 (원자적) |
| 2 | DB 비관적 락 | coupon 테이블 | 수량 차감 동시성 제어 |

### 5.2 Race Condition 방지

```
동시 요청 시나리오:
User A, B가 동시에 쿠폰 발급 요청

┌──────────────────────────────────────────────────────────────┐
│  시간   │  User A                 │  User B                 │
├──────────────────────────────────────────────────────────────┤
│  T1     │  SADD → 1 (성공)        │                         │
│  T2     │                         │  SADD → 0 (중복!)       │
│  T3     │  ZADD (대기열 등록)      │  예외 반환              │
│  T4     │  ZRANK → 0 (1등)        │                         │
│  T5     │  DB 락 획득              │                         │
│  T6     │  UserCoupon 저장        │                         │
│  T7     │  발급 완료               │                         │
└──────────────────────────────────────────────────────────────┘
```

### 5.3 SADD의 원자성 활용

```java
// SADD는 원자적으로 "존재 여부 확인 + 추가"를 수행
Long added = redisTemplate.opsForSet().add(issuedSetKey, userIdStr);
if (added == null || added == 0) {
    // 이미 Set에 존재 → 중복 발급
    throw new BusinessException(ErrorCode.COUPON_ALREADY_ISSUED);
}
// added == 1 → 신규 추가 성공
```

---

## 6. 선착순 검증 로직

### 6.1 Sorted Set 기반 순위 검증

```java
// 1. 대기열 등록 (score = timestamp)
redisTemplate.opsForZSet().add(
    requestQueueKey,
    userIdStr,
    (double) System.currentTimeMillis()
);

// 2. 순위 조회 (0-based)
Long rank = redisTemplate.opsForZSet().rank(requestQueueKey, userIdStr);

// 3. 선착순 검증
if (rank >= maxQuantity) {
    throw new BusinessException(ErrorCode.COUPON_OUT_OF_STOCK);
}
```

### 6.2 순위 계산 예시

```
최대 발급 수량: 3
대기열 상태:
  rank 0: userId=101, score=1707200000001  ← 선착순 통과
  rank 1: userId=102, score=1707200000005  ← 선착순 통과
  rank 2: userId=103, score=1707200000010  ← 선착순 통과
  rank 3: userId=104, score=1707200000015  ← 수량 초과! (rank >= 3)
```

---

## 7. 에러 처리 및 복구

### 7.1 에러 코드 정의

| 에러 코드 | 발생 조건 | 롤백 필요 |
|----------|----------|----------|
| COUPON_ALREADY_ISSUED | SADD 반환값 0 (중복) | 불필요 |
| COUPON_OUT_OF_STOCK | rank >= maxQuantity | 필요 |
| COUPON_NOT_FOUND | 쿠폰 조회 실패 | 필요 |
| COUPON_NOT_AVAILABLE | 유효기간 만료/비활성 | 필요 |
| COUPON_ISSUE_FAILED | 기타 예외 | 필요 |

### 7.2 롤백 메서드

```java
private void rollbackRedis(String issuedSetKey, String requestQueueKey, String userIdStr) {
    try {
        // Set에서 사용자 제거 (중복 체크 원복)
        redisTemplate.opsForSet().remove(issuedSetKey, userIdStr);
        // Sorted Set에서 대기열 제거
        redisTemplate.opsForZSet().remove(requestQueueKey, userIdStr);
    } catch (Exception e) {
        log.error("Redis 롤백 실패", e);
    }
}
```

---

## 8. 시퀀스 다이어그램

### 8.1 정상 발급 케이스

```
Client        CouponController     CouponService        Redis              DB
  │                 │                   │                 │                 │
  │──POST /issue───▶│                   │                 │                 │
  │                 │──issueCoupon()───▶│                 │                 │
  │                 │                   │──SADD issued────▶│                 │
  │                 │                   │◀──1 (성공)───────│                 │
  │                 │                   │                 │                 │
  │                 │                   │──ZADD request───▶│                 │
  │                 │                   │──ZRANK──────────▶│                 │
  │                 │                   │◀──rank=0─────────│                 │
  │                 │                   │──GET quantity───▶│                 │
  │                 │                   │◀──"100"──────────│                 │
  │                 │                   │                 │                 │
  │                 │                   │──findByIdWithLock────────────────▶│
  │                 │                   │◀──Coupon──────────────────────────│
  │                 │                   │──save(UserCoupon)────────────────▶│
  │                 │                   │──save(Coupon)────────────────────▶│
  │                 │                   │                 │                 │
  │                 │◀──UserCouponResponse│                │                 │
  │◀──200 OK────────│                   │                 │                 │
```

### 8.2 중복 발급 케이스

```
Client        CouponController     CouponService        Redis
  │                 │                   │                 │
  │──POST /issue───▶│                   │                 │
  │                 │──issueCoupon()───▶│                 │
  │                 │                   │──SADD issued────▶│
  │                 │                   │◀──0 (중복!)──────│
  │                 │◀──COUPON_ALREADY_ISSUED              │
  │◀──409 Conflict──│                   │                 │
```

### 8.3 수량 초과 케이스

```
Client        CouponController     CouponService        Redis
  │                 │                   │                 │
  │──POST /issue───▶│                   │                 │
  │                 │──issueCoupon()───▶│                 │
  │                 │                   │──SADD issued────▶│
  │                 │                   │◀──1 (성공)───────│
  │                 │                   │──ZADD request───▶│
  │                 │                   │──ZRANK──────────▶│
  │                 │                   │◀──rank=100───────│
  │                 │                   │──GET quantity───▶│
  │                 │                   │◀──"100"──────────│
  │                 │                   │                 │
  │                 │                   │  rank >= maxQty │
  │                 │                   │──SREM issued────▶│ (롤백)
  │                 │                   │──ZREM request───▶│ (롤백)
  │                 │                   │                 │
  │                 │◀──COUPON_OUT_OF_STOCK               │
  │◀──400 Bad Req───│                   │                 │
```

---

## 9. 데이터 초기화

### 9.1 쿠폰 등록 시 Redis 초기화

```java
// 쿠폰 생성/수정 시 최대 수량 Redis에 저장
public void initializeCouponQuantity(Long couponId, Integer maxQuantity) {
    String quantityKey = COUPON_QUANTITY_KEY + couponId;
    redisTemplate.opsForValue().set(quantityKey, String.valueOf(maxQuantity));
}
```

### 9.2 이벤트 시작 전 초기화 체크리스트

| 항목 | 확인 사항 |
|------|----------|
| 수량 설정 | `coupon:quantity:{id}` 값 확인 |
| 기존 발급 데이터 | `coupon:issued:{id}` 초기화 여부 |
| 대기열 데이터 | `coupon:request:{id}` 초기화 여부 |

---

## 10. 고려사항

### 10.1 성능 최적화

| 문제 | 해결책 |
|------|--------|
| Redis 네트워크 지연 | 파이프라인 적용 고려 |
| 대량 동시 요청 | Redis 클러스터 구성 |
| Hot Key 이슈 | 쿠폰별 분산 처리 |

### 10.2 데이터 정합성

| 문제 | 해결책 |
|------|--------|
| Redis-DB 불일치 | 실패 시 Redis 롤백 |
| Redis 장애 시 | DB 비관적 락 Fallback |
| 트랜잭션 롤백 | catch 블록에서 Redis 롤백 |

### 10.3 운영 고려사항

| 항목 | 권장 사항 |
|------|----------|
| Redis TTL | 이벤트 종료 후 키 자동 만료 설정 |
| 모니터링 | 발급 수량, 실패율, 응답시간 추적 |
| 대시보드 | 실시간 발급 현황 조회 API 제공 |

### 10.4 확장 가능성

| 기능 | 구현 방안 |
|------|----------|
| 발급 순서 조회 | `ZRANK` 결과 반환 |
| 대기열 현황 | `ZCARD` 총 요청 수 조회 |
| 발급 통계 | `SCARD` 발급 완료 수 조회 |

---

## 11. 핵심 클래스 구조

```
application/coupon/service/
└── CouponService.java            # 선착순 쿠폰 발급 핵심 로직

domain/coupon/entity/
├── Coupon.java                   # 쿠폰 도메인 (수량, 유효기간)
└── UserCoupon.java               # 사용자 쿠폰 (발급 상태)

domain/coupon/repository/
├── CouponRepository.java         # 쿠폰 저장소
└── UserCouponRepository.java     # 사용자 쿠폰 저장소

presentation/coupon/
└── CouponController.java         # REST API 엔드포인트
```

---

## 12. API 명세

### 12.1 쿠폰 발급 API

```
POST /api/coupons/{couponId}/issue

Request Header:
  - X-User-Id: 1

Response (성공):
{
  "userCouponId": 1,
  "couponId": 1,
  "couponName": "신규 가입 10% 할인",
  "discountType": "PERCENT",
  "discountValue": 10,
  "status": "AVAILABLE",
  "validTo": "2026-02-28T23:59:59"
}

Response (중복 발급):
HTTP 409 Conflict
{
  "code": "COUPON_ALREADY_ISSUED",
  "message": "이미 발급받은 쿠폰입니다."
}

Response (수량 초과):
HTTP 400 Bad Request
{
  "code": "COUPON_OUT_OF_STOCK",
  "message": "쿠폰이 모두 소진되었습니다."
}
```
